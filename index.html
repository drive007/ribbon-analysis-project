<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard: Ribbon Consolidation Analysis & Action Plan (Interactive)</title>
    <style>
        /* --- CSS Variables and Base Styles (Mostly Same) --- */
        :root {
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --heading-color: #0056b3;
            --border-color: #d6dde3;
            --shadow-color: rgba(0, 0, 0, 0.07);
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --accent-orange: #fd7e14;
            --accent-blue: #007bff;
            --font-primary: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --best-option-highlight-bg: #eaf7ec;
            --best-option-border-color: #95d7a1;
            --worst-option-highlight-bg: #fff0f1;
            --worst-option-border-color: #f1b0b7;
            --bar-color-8394: #007bff;
            --bar-color-8393: #001f5a;
            --bar-color-8392: #e67e22;
            --table-header-bg: #e9ecef;
        }
        body { font-family: var(--font-primary); background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; line-height: 1.5; }
        .dashboard-container { max-width: 1300px; margin: auto; background-color: var(--card-bg); padding: 25px; border-radius: 10px; box-shadow: 0 3px 10px var(--shadow-color); border: 1px solid var(--border-color); }
        header { text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 25px; }
        header h1 { color: var(--heading-color); margin: 0 0 5px 0; font-size: 1.8em; font-weight: 600; }
        header p { margin: 5px 0; color: #555; font-size: 1.1em; }
        header .current-cost { font-weight: bold; color: var(--accent-red); }
        .section { margin-bottom: 30px; }
        .section h2 { color: var(--heading-color); font-size: 1.4em; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); text-align: center; }

        /* --- Current Situation & Options Grid (Same Styles) --- */
        .chart-container { border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .chart-container h3 { text-align: center; margin-top: 0; margin-bottom: 15px; font-size: 1.1em; color: #444; }
        .bar-chart-visual { display: flex; flex-direction: column; gap: 8px; }
        .bar-item { display: flex; align-items: center; gap: 10px; }
        .bar-label { width: 60px; font-size: 0.9em; color: #555; text-align: right; flex-shrink: 0; }
        .bar-wrapper { flex-grow: 1; background-color: #f0f0f0; border-radius: 4px; overflow: hidden; }
        .bar { height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; color: white; font-size: 0.8em; white-space: nowrap; }
        .bar.item-8394 { background-color: var(--bar-color-8394); }
        .bar.item-8393 { background-color: var(--bar-color-8393); }
        .bar.item-8392 { background-color: var(--bar-color-8392); }
        .current-summary-table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 15px;}
        .current-summary-table th, .current-summary-table td { border: 1px solid var(--border-color); padding: 8px; text-align: right; }
        .current-summary-table th { background-color: var(--table-header-bg); text-align: left;}
        .current-summary-table tfoot td { font-weight: bold; }
        .current-summary-table .item-no { text-align: left; }
        .problems-list { list-style: none; padding: 0; }
        .problems-list li { background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 10px 15px; margin-bottom: 10px; border-radius: 4px; }
        .problems-list strong { color: #856404; }
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .option-card { border: 1px solid var(--border-color); border-radius: 8px; padding: 18px; background-color: #fdfdfd; display: flex; flex-direction: column; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .option-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .option-card.best-option { background-color: var(--best-option-highlight-bg); border: 2px solid var(--best-option-border-color); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15); }
        .option-card.best-option h2 { color: var(--accent-green); }
        .option-card.worst-consolidation-option { background-color: var(--worst-option-highlight-bg); border: 2px solid var(--worst-option-border-color); box-shadow: 0 4px 12px rgba(220, 53, 69, 0.1); }
        .option-card.worst-consolidation-option h2 { color: var(--accent-red); }
        .option-card h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.2em; color: var(--heading-color); text-align: center; border-bottom: 1px solid #eee; padding-bottom: 8px; font-weight: 600; }
        .option-card h2 .brand { font-weight: 400; font-size: 0.9em; color: #666; display: block; }
        .metric { margin-bottom: 10px; font-size: 0.9em; line-height: 1.4; }
        .metric strong { display: block; color: #555; margin-bottom: 2px; font-weight: 600; font-size: 0.85em; text-transform: uppercase; }
        .metric .value { font-size: 1.05em; font-weight: bold; padding: 1px 0; }
        .metric .value.cost { color: var(--heading-color); }
        .metric .value.risk-critical { color: var(--accent-red); }
        .metric .value.risk-medium { color: var(--accent-orange); }
        .metric .value.risk-low { color: var(--accent-green); }
        .metric .note { font-size: 0.85em; color: #666; display: block; margin-top: 2px;}
        .savings-metric { margin-top: auto; padding-top: 10px; border-top: 1px dashed var(--border-color); text-align: center; }
        .savings-metric strong { font-size: 0.9em; text-transform: uppercase; color: #555; margin-bottom: 4px; }
        .savings-metric .value { font-size: 1.5em; font-weight: bold; color: var(--accent-green); }
        .savings-metric .note { font-size: 0.85em; color: #666;}
        .savings-metric .per-roll { font-size: 0.95em; color: var(--accent-green); font-weight: 500; display: block; margin-top: 5px;}
        .durability-icon { font-size: 1.3em; margin-right: 5px; }
        .durability-basic { color: #6c757d; }
        .durability-good { color: #17a2b8; }
        .durability-verygood { color: #0056b3; }
        .durability-excellent { color: #004085; }
        .details-button { display: block; padding: 9px 15px; margin-top: 10px; background-color: var(--heading-color); color: white !important; text-decoration: none; border: none; border-radius: 5px; text-align: center; font-size: 0.9em; font-weight: 500; cursor: pointer; transition: background-color 0.3s ease, box-shadow 0.2s ease; }
        .details-button:hover { background-color: #004085; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .option-card.best-option .details-button { background-color: var(--accent-green); }
        .option-card.best-option .details-button:hover { background-color: #1e7e34; }
        .option-card.worst-consolidation-option .details-button { background-color: var(--accent-red); }
        .option-card.worst-consolidation-option .details-button:hover { background-color: #a71d2a; }

        /* --- Action Plan / To-Do List --- */
        .action-plan-box { margin-top: 25px; padding: 25px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #f0f8ff; border-left: 5px solid var(--accent-orange); }
        .action-plan-box h2 { color: var(--heading-color); text-align: center; }
        .action-buttons { text-align: right; margin-bottom: 15px; margin-top: -10px; display: flex; justify-content: space-between; align-items: center;}
        .action-buttons button, .action-buttons a { padding: 6px 12px; margin-left: 8px; font-size: 0.85em; border-radius: 4px; cursor: pointer; text-decoration: none; color: white; border: none; }
        .add-row-btn { background-color: var(--accent-blue); }
        .add-row-btn:hover { background-color: #0056b3; }
        .save-btn { background-color: var(--accent-green); }
        .save-btn:hover { background-color: #1e7e34; }
        .confirm-btn { background-color: var(--accent-orange); }
        .confirm-btn:hover { background-color: #d35400; }
        .export-btn { background-color: #1a5276 ; }
        .export-btn:hover { background-color: #113a56; }
        .hidden-file-input { display: none; }
        .import-btn { background-color: var(--accent-purple); }
        .import-btn:hover { background-color: #5a2b9d; }

        .todo-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        .todo-table th, .todo-table td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; vertical-align: top; }
        .todo-table th { background-color: #d6eaf8; font-weight: 600; vertical-align: middle;}
        .todo-table select, .todo-table input, .todo-table textarea {
             width: 98%;
             padding: 5px;
             border: 1px solid #ccc;
             border-radius: 4px;
             font-size: 1em;
             box-sizing: border-box;
             margin-bottom: 4px;
         }
         /* Styling for nested elements inside Task Description cell */
         .task-cell-content { display: flex; flex-direction: column; }
         .task-input { margin-bottom: 8px !important; } /* Main task input */
         .sub-details { /* Container for Responsible and Notes */
             display: flex;
             gap: 15px; /* Space between Responsible and Notes */
             margin-top: 5px;
             padding-left: 15px; /* Indent sub-details */
             border-left: 2px solid #eee; /* Visual indicator for nesting */
             padding-top: 8px;
             padding-bottom: 8px;
         }
         .responsible-block, .notes-block {
             flex: 1; /* Allow blocks to share space */
             min-width: 150px; /* Prevent excessive shrinking */
         }
         .responsible-block label, .notes-block label {
             display: block;
             font-size: 0.8em;
             color: #666;
             margin-bottom: 3px;
             font-weight: 500;
             text-transform: uppercase;
         }
         .responsible-block select, .responsible-block input,
         .notes-block textarea {
            width: 100%; /* Make inputs/textarea fill their block */
            font-size: 0.95em !important; /* Slightly smaller font for nested */
         }
         .notes-block textarea { height: 45px; } /* Smaller default height */


         .todo-table td:nth-child(1) { width: 45%; } /* Task + Nested */
         /* Removed specific widths for Resp/Notes as they are inside Task cell now */
         .todo-table td:nth-child(2) { width: 15%; } /* Status */
         .todo-table td:nth-child(3) { width: 100px; } /* Due Date */
         .todo-table td:last-child { width: 70px; text-align: center; vertical-align: middle;} /* Actions */

         .action-btn { background: none; border: none; cursor: pointer; font-size: 1.1em; padding: 2px 4px; vertical-align: middle; }
         .move-up-btn { color: var(--accent-blue); }
         .move-down-btn { color: var(--accent-blue); }
         .delete-row-btn { color: var(--accent-red); }
         .confirmed input, .confirmed select, .confirmed textarea { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }
         .confirmed .action-btn { display: none; }

        /* --- Notes Footer --- */
        .notes { text-align: center; font-size: 0.85em; color: #777; margin-top: 30px; padding-top: 15px; border-top: 1px dashed var(--border-color); }

        /* --- Responsive --- */
        @media (max-width: 992px) {
            .options-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
            .sub-details { flex-direction: column; gap: 8px; } /* Stack Resp and Notes */
        }
        @media (max-width: 768px) {
            .options-grid { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
            header h1 { font-size: 1.6em; }
            .option-card h2 { font-size: 1.15em; }
            .todo-table { display: block; overflow-x: auto; }
            .todo-table th, .todo-table td { white-space: normal; } /* Allow wrap */
             .todo-table td:nth-child(1) { min-width: 250px; } /* Give Task cell more space */
             .todo-table td:nth-child(2) { min-width: 120px; } /* Status */
             .todo-table td:nth-child(3) { min-width: 100px; } /* Due Date */
             .todo-table td:last-child { min-width: 70px; } /* Actions */
        }
        @media (max-width: 576px) {
            .options-grid { grid-template-columns: 1fr; }
            header p { font-size: 1em; }
            .action-plan-box h2 { font-size: 1.3em; }
        }

    </style>
</head>
<body>
    <div class="dashboard-container">
         <header>
             <h1>Ribbon Consolidation Analysis & Action Plan</h1>
             <p>Evaluating Single & Multi-Ribbon Replacements for 3 Current SKUs</p> <!-- Updated subtitle -->
        </header>

        <!-- Current Situation Section -->
        <div class="section">
            <h2>Current Situation (2024 Data)</h2>
            <!-- ... (Content remains the same) ... -->
             <div class="chart-container">
                 <h3>Total Annual Purchase Quantity</h3>
                 <div class="bar-chart-visual">
                     <div class="bar-item"> <span class="bar-label">8-394 (W/R)</span><div class="bar-wrapper"><div class="bar item-8394" style="width: 100%;">800</div></div> </div>
                     <div class="bar-item"> <span class="bar-label">8-393 (Wax)</span><div class="bar-wrapper"><div class="bar item-8393" style="width: 68.75%;">550</div></div> </div>
                     <div class="bar-item"> <span class="bar-label">8-392 (W/R)</span><div class="bar-wrapper"><div class="bar item-8392" style="width: 26.25%;">210</div></div> </div>
                 </div>
                 <table class="current-summary-table">
                    <thead><tr><th class="item-no">Item No.</th><th>Type</th><th>Rolls/Year</th><th>Avg Rolls/Month</th><th>Cost/Roll (THB)</th><th>Est. Annual Cost (THB)</th></tr></thead>
                    <tbody>
                        <tr><td class="item-no">8-394</td><td>Wax/Resin</td><td>800</td><td>~67</td><td>675</td><td>~540,000</td></tr>
                        <tr><td class="item-no">8-393</td><td>Wax</td><td>550</td><td>~46</td><td>305</td><td>~167,750</td></tr>
                        <tr><td class="item-no">8-392</td><td>Wax/Resin</td><td>210</td><td>~18</td><td>575</td><td>~120,750</td></tr>
                    </tbody>
                    <tfoot><tr><td colspan="2" class="item-no"><strong>Total / Weighted Avg</strong></td><td><strong>1,560</strong></td><td><strong>130</strong></td><td><strong>~531</strong></td><td><strong>~828,500</strong></td></tr></tfoot>
                </table>
             </div>
             <div class="chart-container">
                 <h3>Identified Problems</h3>
                 <ul class="problems-list">
                     <li><strong>High Cost:</strong> Current weighted average cost/roll is ~531 THB. Total annual spend: <strong class="current-cost">~828,500 THB</strong>.</li>
                    <li><strong>Potential Ribbon Waste:</strong> Using 117mm ribbon (8-394) for labels narrower than 110mm leads to unused material.</li>
                    <li><strong>Complexity:</strong> Managing 3 SKUs increases overhead & potential user error. (Reduced to 2 SKUs with scenario)</li>
                 </ul>
            </div>
        </div>

        <!-- Consolidation Options Section -->
         <div class="section">
             <h2>Consolidation Options Analysis</h2>
             <div class="options-grid">
                 <!-- Scenario: K2000 + K102N - New Best Option -->
                 <div class="option-card best-option">
                     <h2>K2000 + K102N <span class="brand">KURZ Scenario (2 SKUs)</span></h2>
                     <div class="metric"><strong>Type:</strong> <span class="value">Wax/Resin + Wax</span></div>
                     <div class="metric"><strong>Durability:</strong> <span class="value"><span class="durability-icon durability-good">■</span>Maintained</span> <span class="note">Appropriate types used</span></div>
                     <div class="metric"><strong>Price/Roll:</strong> <span class="value cost">K2000@245, K102N@175</span> <span class="note">(THB, specific sizes)</span></div>
                     <div class="metric"><strong>Durability Risk:</strong> <span class="value risk-low">Low</span> <span class="note">Reduces SKU complexity (3 to 2)</span></div>
                     <div class="savings-metric">
                         <strong>Est. Annual Savings</strong>
                         <span class="value">~485k THB</span><span class="note">(~58.5%)</span>
                         <span class="per-roll">~311 THB Saved/Roll (Avg)</span>
                     </div>
                     <a href="Analysis_K2000_K102N_Scenario.html" target="_blank" class="details-button">View Scenario Details</a>
                 </div>

                 <!-- KURZ K2000 - Best Option (Single SKU Replacement) -->
                  <div class="option-card best-option">
                     <h2>K2000 <span class="brand">KURZ (Single SKU)</span></h2>
                     <div class="metric"><strong>Type:</strong> <span class="value">Wax/Resin (Std)</span></div>
                     <div class="metric"><strong>Durability:</strong> <span class="value"><span class="durability-icon durability-good">■</span>Good</span></div>
                     <div class="metric"><strong>Price/Roll:</strong> <span class="value cost">245 THB</span> <span class="note">(117mm used)</span></div>
                     <div class="metric"><strong>Durability Risk:</strong> <span class="value risk-low">Low</span> <span class="note">Similar type to current W/R</span></div>
                      <div class="savings-metric">
                         <strong>Est. Annual Savings</strong>
                         <span class="value">~446k THB</span><span class="note">(~53.9%)</span>
                         <span class="per-roll">~286 THB Saved/Roll (Avg)</span>
                     </div>
                     <a href="Analysis_K2000.html" target="_blank" class="details-button">View Details</a>
                 </div>
                  <!-- SATO T102F -->
                 <div class="option-card">
                     <h2>T102F <span class="brand">SATO</span></h2>
                     <div class="metric"><strong>Type:</strong> <span class="value">Wax</span></div>
                     <div class="metric"><strong>Durability:</strong> <span class="value"><span class="durability-icon durability-basic">■</span>Basic</span></div>
                     <div class="metric"><strong>Price/Roll:</strong> <span class="value cost">295 THB</span> <span class="note">(110mm)</span></div>
                     <div class="metric"><strong>Durability Risk:</strong> <span class="value risk-critical">Critical</span> <span class="note">vs. current W/R</span></div>
                     <div class="savings-metric">
                         <strong>Est. Annual Savings</strong>
                         <span class="value">~368k THB</span><span class="note">(~44.5%)</span>
                         <span class="per-roll">~236 THB Saved/Roll (Avg)</span>
                     </div>
                     <a href="Analysis_T102F.html" target="_blank" class="details-button">View Details</a>
                 </div>
                 <!-- KURZ K102N -->
                 <div class="option-card">
                     <h2>K102N <span class="brand">KURZ</span></h2>
                     <div class="metric"><strong>Type:</strong> <span class="value">Wax (Standard)</span></div>
                     <div class="metric"><strong>Durability:</strong> <span class="value"><span class="durability-icon durability-basic">■</span>Basic</span></div>
                     <div class="metric"><strong>Price/Roll:</strong> <span class="value cost">155 THB</span> <span class="note">(117mm used)</span></div>
                     <div class="metric"><strong>Durability Risk:</strong> <span class="value risk-critical">Critical</span> <span class="note">vs. current W/R</span></div>
                      <div class="savings-metric">
                         <strong>Est. Annual Savings</strong>
                         <span class="value">~587k THB</span><span class="note">(~70.8%)</span>
                         <span class="per-roll">~376 THB Saved/Roll (Avg)</span>
                     </div>
                     <a href="Analysis_K102N.html" target="_blank" class="details-button">View Details</a>
                 </div>
                  <!-- KURZ K103N -->
                  <div class="option-card">
                     <h2>K103N <span class="brand">KURZ</span></h2>
                     <div class="metric"><strong>Type:</strong> <span class="value">Wax (Premium)</span></div>
                     <div class="metric"><strong>Durability:</strong> <span class="value"><span class="durability-icon durability-basic">■</span>Basic+</span> <span class="note">Slightly better Wax</span></div>
                     <div class="metric"><strong>Price/Roll:</strong> <span class="value cost">190 THB</span> <span class="note">(117mm used)</span></div>
                     <div class="metric"><strong>Durability Risk:</strong> <span class="value risk-critical">Critical</span> <span class="note">vs. current W/R</span></div>
                      <div class="savings-metric">
                         <strong>Est. Annual Savings</strong>
                         <span class="value">~532k THB</span><span class="note">(~64.2%)</span>
                         <span class="per-roll">~341 THB Saved/Roll (Avg)</span>
                     </div>
                     <a href="Analysis_K103N.html" target="_blank" class="details-button">View Details</a>
                 </div>
                  <!-- KURZ K308 -->
                  <div class="option-card">
                     <h2>K308 <span class="brand">KURZ</span></h2>
                     <div class="metric"><strong>Type:</strong> <span class="value">Wax/Resin (Prem)</span></div>
                     <div class="metric"><strong>Durability:</strong> <span class="value"><span class="durability-icon durability-verygood">■</span>Very Good</span></div>
                     <div class="metric"><strong>Price/Roll:</strong> <span class="value cost">315 THB</span> <span class="note">(117mm used)</span></div>
                     <div class="metric"><strong>Durability Risk:</strong> <span class="value risk-low">Low</span> <span class="note">Likely exceeds current W/R</span></div>
                      <div class="savings-metric">
                         <strong>Est. Annual Savings</strong>
                         <span class="value">~337k THB</span><span class="note">(~40.7%)</span>
                         <span class="per-roll">~216 THB Saved/Roll (Avg)</span>
                     </div>
                     <a href="Analysis_K308.html" target="_blank" class="details-button">View Details</a>
                 </div>
                 <!-- KURZ K504 - Worst Option -->
                  <div class="option-card worst-consolidation-option">
                     <h2>K504 <span class="brand">KURZ</span></h2>
                     <div class="metric"><strong>Type:</strong> <span class="value">Resin (Premium)</span></div>
                     <div class="metric"><strong>Durability:</strong> <span class="value"><span class="durability-icon durability-excellent">■</span>Excellent</span></div>
                     <div class="metric"><strong>Price/Roll:</strong> <span class="value cost">~480 THB</span> <span class="note">(Example Size)</span></div>
                     <div class="metric"><strong>Use Case:</strong> <span class="value" style="color: var(--heading-color)">Specialized</span><span class="note">Only for extreme durability needs.</span></div>
                      <div class="savings-metric">
                          <strong>Est. Annual Savings</strong>
                         <span class="value" style="color:var(--accent-red)">N/A*</span><span class="note">Likely higher cost</span>
                         <span class="per-roll" style="color:var(--accent-red)">~ -51 THB Saved/Roll (Avg)</span>
                     </div>
                      <a href="Analysis_K504.html" target="_blank" class="details-button">View Details</a>
                 </div>
             </div>
        </div> <!-- End Options Section -->

        <!-- Action Plan Section (Updated Structure) -->
        <div class="section action-plan-box">
            <h2>Action Plan & To-Do List</h2>
             <div class="action-buttons">
                 <button class="add-row-btn" onclick="addTaskRow()">+ Add Task</button>
                 <div>
                    <button class="save-btn" onclick="saveData()">Save Changes</button>
                    <button class="confirm-btn" onclick="confirmData()">Confirm Plan</button>
                    <a href="#" class="export-btn" onclick="exportToExcel(event)">Export to Excel</a>
                 </div>
             </div>
            <table class="todo-table" id="todoTable">
                <thead>
                    <tr>
                        <th>Task Description & Details</th> <!-- Combined Column -->
                        <th>Status</th>
                        <th>Target Due</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="todoTableBody">
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div> <!-- End Action Plan Section -->

        <!-- Notes Footer -->
        <div class="notes">
             <!-- ... (Content remains the same) ... -->
             Analysis based on 2024 usage data and provided quotations/datasheets (Apr 2025 Prices). Savings calculated assuming full 1,560 roll replacement for single SKU options. Scenario savings calculated based on its specific roll distribution.
            <br><strong>*K504 Savings N/A:</strong> Full replacement would likely increase total costs. Button links placeholders.
            <br><strong>Thorough testing confirming print quality, durability, and operational impact is essential before any change.</strong>
        </div>

    </div> <!-- End Dashboard Container -->

    <!-- *** Include SheetJS Library HERE *** -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        const LOCAL_STORAGE_KEY = 'ribbonConsolidationPlanV6'; // Incremented key for new structure/data
        const todoTableBody = document.getElementById('todoTableBody');
        // const csvFileInput = document.getElementById('csvFileInput'); // Removed as no import button in HTML
        const departments = ["Procurement", "QA", "Production", "Engineering", "IT", "Maintenance", "Management", "Finance", "Other"];
        const statusOptions = {
            "not-started": "Not Started", "in-progress": "In Progress", "completed": "Completed",
            "blocked": "Blocked", "on-hold": "On Hold", "scheduled": "Scheduled",
            "planning": "Planning", "na": "N/A"
        };

        // --- Initial Task Data (Generic, can be overridden by specific scenario choice) ---
         let currentTasks = [ // Default tasks, might be replaced if a specific scenario's plan is "loaded"
             { task: "1. Select a Primary Consolidation Option/Scenario for Detailed Action Planning", department: "Management", name: "Project Lead", email: "", notes: "Review options, then tailor this plan.", status: "not-started", dueDate: "" },
             { task: "2. Procure Test Samples for Chosen Option(s)", department: "Procurement", name: "", email: "", notes: "", status: "not-started", dueDate: "" },
             { task: "3. Define Detailed Test Protocol", department: "QA", name: "", email: "", notes: "", status: "not-started", dueDate: "" },
             { task: "4. Execute Performance Testing", department: "QA", name: "", email: "", notes: "", status: "not-started", dueDate: "" },
             { task: "5. Assess Dimension Impact & Waste (if applicable)", department: "Engineering", name: "", email: "", notes: "", status: "not-started", dueDate: "" },
             { task: "6. Compile Results & Final Analysis", department: "Other", name: "", email: "", notes: "", status: "not-started", dueDate: "" },
             { task: "7. Final Decision Meeting", department: "Management", name: "", email: "", notes: "", status: "not-started", dueDate: "" },
             { task: "8. Develop & Execute Implementation Plan", department: "Production", name: "", email: "", notes: "If approved.", status: "not-started", dueDate: "" }
         ];
        // Store initial tasks for different scenarios if needed, e.g.:
        const scenarioTasksK2000K102N = [
            { task: "SCENARIO: 1. Confirm K102N 110mm Price & Availability", department: "Procurement", name: "Purchaser A", email: "purchaser.a@example.com", notes: "Verify 175 THB price for 110mm.", status: "not-started", dueDate: "2025-05-10" },
            { task: "SCENARIO: 2. Procure Test Samples (K2000-117mm & K102N-110mm*)", department: "Procurement", name: "Purchaser A", email: "purchaser.a@example.com", notes: "*Confirm K102N 110mm price/avail. Need ~5 rolls K2000, ~3 K102N", status: "not-started", dueDate: "2025-05-20" },
            { task: "SCENARIO: 3. Define Detailed Test Protocol (for K2000 & K102N)", department: "QA", name: "QA Lead", email: "qalead@example.com", notes: "Focus K2000 on W/R, K102N on Wax", status: "not-started", dueDate: "2025-05-25" },
            { task: "SCENARIO: 4. Execute Performance Testing", department: "QA", name: "QA Tech", email: "qatech@example.com", notes: "", status: "not-started", dueDate: "2025-06-25" },
            { task: "   4.1 K2000 vs 8-394/8-392 (JP PACK, Gowns, SPT, OEM)", department: "QA", name: "QA Tech", email: "qatech@example.com", notes: "Critical durability focus", status: "na", dueDate: "" },
            { task: "   4.2 K102N vs 8-393 (Wraps, Masks)", department: "QA", name: "QA Tech", email: "qatech@example.com", notes: "Compare vs BEA YI", status: "na", dueDate: "" },
            { task: "SCENARIO: 5. Assess K2000 117mm on 85mm lines (Waste/Guides)", department: "Engineering", name: "Prod. Eng.", email: "prod.eng@example.com", notes: "Quantify waste", status: "not-started", dueDate: "2025-06-30" },
            { task: "SCENARIO: 6. (Optional) Request Quote K2000 85mm from KURZ", department: "Procurement", name: "Purchaser A", email: "purchaser.a@example.com", notes: "Based on waste assessment", status: "on-hold", dueDate: "2025-07-05" },
            { task: "SCENARIO: 7. Compile Test Results & Scenario Analysis", department: "Other", name: "Project Lead", email: "project.lead@example.com", notes: "Include waste cost if applicable", status: "not-started", dueDate: "2025-07-20" },
            { task: "SCENARIO: 8. Final Decision Meeting (Scenario Go/No-Go)", department: "Management", name: "Mgmt Team", email: "", notes: "", status: "not-started", dueDate: "2025-08-05" },
            { task: "SCENARIO: 9. Develop & Execute Implementation Plan (If Approved)", department: "Production", name: "All", email: "", notes: "Focus on 2 SKUs", status: "not-started", dueDate: "" }
        ];
        const scenarioTasksK2000Single = [
             { task: "K2000-SINGLE: 1. Procure Test Samples (KURZ K2000 - 117mm)", department: "Procurement", name: "Purchaser A", email: "purchaser.a@example.com", notes: "Need 5-10 rolls for comprehensive QA tests against all 3 current SKUs.", status: "not-started", dueDate: "2025-05-15" },
             { task: "K2000-SINGLE: 2. Define Detailed Test Protocol", department: "QA", name: "QA Lead", email: "qalead@example.com", notes: "K2000 to be tested against 8-394, 8-393, 8-392 requirements.", status: "not-started", dueDate: "2025-05-20" },
             { task: "   2.1 Specify Substrates (All current labels)", department: "QA", name: "QA Lead", email: "qalead@example.com", notes: "JP PACK, Gowns, SPT, OEM, Wraps, Masks.", status: "na", dueDate: "" },
             { task: "   2.2 Define Durability Tests", department: "QA", name: "QA Lead", email: "qalead@example.com", notes: "Critical for W/R replacement (JP PACK, Gowns, etc.). Assess if acceptable for current Wax uses (Wraps, Masks).", status: "na", dueDate: "" },
             { task: "K2000-SINGLE: 3. Execute K2000 Performance Testing", department: "QA", name: "QA Tech", email: "qatech@example.com", notes: "Compare against all 3 current ribbons.", status: "not-started", dueDate: "2025-06-15" },
             { task: "K2000-SINGLE: 4. Assess Dimension Impact & Waste", department: "Engineering", name: "Prod. Eng.", email: "prod.eng@example.com", notes: "Using 117mm for 110mm & 85mm applications. Quantify waste.", status: "not-started", dueDate: "2025-06-20" },
             { task: "K2000-SINGLE: 5. Evaluate Optimized Sizing Options with KURZ", department: "Procurement", name: "Purchaser A", email: "purchaser.a@example.com", notes: "Ask for 110mm, 85mm K2000 pricing if waste is significant.", status: "not-started", dueDate: "2025-06-30" },
             { task: "K2000-SINGLE: 6. Compile Results & Final Analysis", department: "Other", name: "Project Lead", email: "project.lead@example.com", notes: "Include cost of waste or cost of optimized sizes.", status: "not-started", dueDate: "2025-07-15" },
             { task: "K2000-SINGLE: 7. Final Decision Meeting", department: "Management", name: "Mgmt Team", email: "", notes: "", status: "not-started", dueDate: "2025-07-30" },
             { task: "K2000-SINGLE: 8. Develop & Execute Implementation Plan", department: "Production", name: "All", email: "", notes: "If approved.", status: "not-started", dueDate: "" }
        ];


        // --- Row Creation (Updated for Combined Task Cell) ---
        function createRowHtml(taskData, isConfirmed = false) {
            const row = todoTableBody.insertRow();
            if (isConfirmed) row.classList.add('confirmed');

            const taskDetailCell = row.insertCell();
            taskDetailCell.style.verticalAlign = 'top';
            taskDetailCell.innerHTML = `
                <div class="task-cell-content">
                    <input type="text" class="task-input" value="${taskData.task || ''}" placeholder="Task Description" ${isConfirmed ? 'disabled' : ''}>
                    <div class="sub-details">
                        <div class="responsible-block">
                            <label>Responsible</label>
                            <select class="dept-select" ${isConfirmed ? 'disabled' : ''}>
                                ${departments.map(dept => `<option value="${dept}" ${taskData.department === dept ? 'selected' : ''}>${dept}</option>`).join('')}
                            </select>
                            <input type="text" class="resp-name-input" value="${taskData.name || ''}" placeholder="Name" ${isConfirmed ? 'disabled' : ''}>
                            <input type="email" class="resp-email-input" value="${taskData.email || ''}" placeholder="Email" ${isConfirmed ? 'disabled' : ''}>
                        </div>
                        <div class="notes-block">
                            <label>Notes / Files</label>
                            <textarea class="notes-input" placeholder="Add notes or file links..." ${isConfirmed ? 'disabled' : ''}>${taskData.notes || ''}</textarea>
                        </div>
                    </div>
                </div>
            `;

            const statusCell = row.insertCell();
            const statusSelect = document.createElement('select');
            statusSelect.className = 'status-select';
            statusSelect.disabled = isConfirmed;
             Object.entries(statusOptions).forEach(([value, text]) => {
                const option = document.createElement('option');
                option.value = value; option.textContent = text;
                if (taskData.status === value) option.selected = true;
                statusSelect.appendChild(option);
            });
            statusCell.appendChild(statusSelect);

            const dateCell = row.insertCell();
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.value = taskData.dueDate || '';
            dateInput.disabled = isConfirmed;
            dateCell.appendChild(dateInput);

            const actionCell = row.insertCell();
            if (!isConfirmed) {
                 actionCell.innerHTML = `
                    <button class="action-btn move-up-btn" onclick="moveRow(this, -1)" title="Move Up">⬆️</button>
                    <button class="action-btn move-down-btn" onclick="moveRow(this, 1)" title="Move Down">⬇️</button>
                    <button class="action-btn delete-row-btn" onclick="deleteRow(this)" title="Delete Task">🗑️</button>
                `;
            }
            return row;
        }

        function getTableData(includeConfirmedStatus = false) {
            const data = [];
            const rows = todoTableBody.rows;
            for (let i = 0; i < rows.length; i++) {
                const taskCell = rows[i].cells[0];
                const statusCell = rows[i].cells[1];
                const dateCell = rows[i].cells[2];
                const rowData = {
                    task: taskCell.querySelector('.task-input').value,
                    department: taskCell.querySelector('.dept-select').value,
                    name: taskCell.querySelector('.resp-name-input').value,
                    email: taskCell.querySelector('.resp-email-input').value,
                    notes: taskCell.querySelector('.notes-input').value,
                    status: statusCell.querySelector('.status-select').value,
                    dueDate: dateCell.querySelector('input[type="date"]').value
                };
                 if (includeConfirmedStatus) {
                     rowData.confirmed = rows[i].classList.contains('confirmed');
                 }
                data.push(rowData);
            }
            return data;
        }
        
        function populateTableWithTasks(tasksToLoad, isPlanConfirmedOverall) {
            todoTableBody.innerHTML = ''; // Clear existing rows
            tasksToLoad.forEach(task => {
                // Ensure all task objects have all necessary fields, even if empty, to avoid errors
                const fullTaskData = {
                    task: task.task || "",
                    department: task.department || departments[0],
                    name: task.name || "",
                    email: task.email || "",
                    notes: task.notes || "",
                    status: task.status || "not-started",
                    dueDate: task.dueDate || "",
                    confirmed: task.confirmed || false
                };
                createRowHtml(fullTaskData, isPlanConfirmedOverall || fullTaskData.confirmed);
            });
        }


        function loadData() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            let activeTasks = JSON.parse(JSON.stringify(currentTasks)); // Default to generic tasks

            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        // If there's saved data, use it. It might be generic or scenario-specific.
                        activeTasks = parsedData.map(task => ({
                            ...task, // Spread saved task properties
                            // Ensure all base properties exist to prevent errors if saved data is partial
                            department: task.department || departments[0],
                            name: task.name || "",
                            email: task.email || "",
                            notes: task.notes || "",
                            status: task.status || "not-started",
                            dueDate: task.dueDate || "",
                            confirmed: task.confirmed || false
                        }));
                    } else if (Array.isArray(parsedData) && parsedData.length === 0) {
                        // If saved data is an empty array (e.g., user deleted all tasks), stick to default tasks.
                        // No change needed, activeTasks is already currentTasks
                    }
                } catch (e) {
                    console.error("Error parsing saved data:", e);
                    // Fallback to default tasks if parsing fails
                    activeTasks = JSON.parse(JSON.stringify(currentTasks));
                }
            }
            
            const isPlanConfirmedOverall = localStorage.getItem(LOCAL_STORAGE_KEY + '_confirmed') === 'true';
            populateTableWithTasks(activeTasks, isPlanConfirmedOverall);

            if (isPlanConfirmedOverall) {
                disableActionButtons(true);
            }
        }


         function saveData() {
             try {
                 const dataToSave = getTableData(true);
                 localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
                 // Determine if the overall plan is confirmed based on any row being confirmed or the global flag
                 const isAnyRowConfirmed = dataToSave.some(row => row.confirmed);
                 const isGloballyConfirmed = localStorage.getItem(LOCAL_STORAGE_KEY + '_confirmed') === 'true';
                 localStorage.setItem(LOCAL_STORAGE_KEY + '_confirmed', isAnyRowConfirmed || isGloballyConfirmed);

                 alert('Action plan saved.');
             } catch (e) { console.error("Error saving:", e); alert('Error saving data.'); }
         }

        function addTaskRow() {
             const isConfirmed = localStorage.getItem(LOCAL_STORAGE_KEY + '_confirmed') === 'true';
             if (isConfirmed) { alert("Plan is confirmed and locked. Cannot add new tasks."); return; }
             createRowHtml({ task: "", department: departments[0], name: "", email: "", notes: "", status: "not-started", dueDate: "" });
        }

        function deleteRow(button) {
            const row = button.closest('tr');
            if (row.classList.contains('confirmed')) {
                 alert("This task is part of a confirmed plan and cannot be deleted individually. Unconfirm the plan to make changes if necessary (feature not typically available without admin override).");
                 return;
            }
             if (confirm('Are you sure you want to delete this task?')) { row.remove(); /* Optionally save: saveData(); */ }
        }
        function moveRow(button, direction) {
            const row = button.closest('tr');
             if (row.classList.contains('confirmed')) {
                alert("Cannot reorder tasks in a confirmed plan.");
                return;
            }
             const tbody = row.parentNode;
             const index = Array.from(tbody.children).indexOf(row);
             if (direction === -1 && index > 0) { tbody.insertBefore(row, tbody.children[index - 1]); }
             else if (direction === 1 && index < tbody.children.length - 1) { tbody.insertBefore(row, tbody.children[index + 2] || null); }
             /* Optionally save: saveData(); */
        }
         function disableActionButtons(disable = true){
             const buttons = document.querySelectorAll('.action-buttons button, .action-buttons a');
             buttons.forEach(btn => {
                 // The "Save Changes" button should ideally remain active unless plan is confirmed.
                 // However, for simplicity here, disable all except potentially an "Unconfirm" if that was a feature.
                 btn.disabled = disable;
                 btn.style.opacity = disable ? 0.6 : 1; // Adjusted opacity
                 btn.style.cursor = disable ? 'not-allowed' : 'pointer';
             });
             const addBtn = document.querySelector('.add-row-btn');
             if(addBtn) {
                addBtn.disabled = disable;
                addBtn.style.opacity = disable ? 0.6 : 1;
                addBtn.style.cursor = disable ? 'not-allowed' : 'pointer';
             }
         }
        function confirmData() {
             if (confirm('Are you sure you want to confirm this action plan? This will lock the tasks for editing and reordering.')) {
                 const rows = todoTableBody.rows;
                 for (let i = 0; i < rows.length; i++) {
                     rows[i].classList.add('confirmed');
                     const inputs = rows[i].querySelectorAll('input, select, textarea');
                     inputs.forEach(input => input.disabled = true);
                     const actionBtns = rows[i].querySelectorAll('.action-btn');
                     actionBtns.forEach(btn => btn.style.display = 'none');
                 }
                 localStorage.setItem(LOCAL_STORAGE_KEY + '_confirmed', 'true');
                 disableActionButtons(true); // Disable top-level action buttons
                 alert('Action plan confirmed and locked.');
                 saveData(); // Save the confirmed state
             }
        }
        function exportToExcel(event) {
            event.preventDefault();
            if (typeof XLSX === 'undefined') { alert('SheetJS library not loaded.'); return; }
            const data = getTableData();
            const dataForExport = data.map(row => ({
                "Task Description": row.task,
                "Responsible Dept": row.department,
                "Responsible Name": row.name,
                "Email": row.email,
                "Notes / Files": row.notes,
                "Status": statusOptions[row.status] || row.status,
                "Target Due Date": row.dueDate
            }));
            try {
                const ws = XLSX.utils.json_to_sheet(dataForExport);
                const colWidths = Object.keys(dataForExport[0] || {}).map(key => {
                     let maxLen = key.length;
                     dataForExport.forEach(item => {
                         const cellValue = item[key] ? String(item[key]) : '';
                         const lines = cellValue.split('\n'); // Handle multi-line cells
                         lines.forEach(line => { if (line.length > maxLen) { maxLen = line.length; } });
                     });
                      if (key === "Task Description") return { wch: Math.min(maxLen + 5, 60) };
                      if (key === "Notes / Files") return { wch: Math.min(maxLen + 5, 50) };
                     return { wch: Math.min(maxLen + 2, 30) };
                 });
                 ws['!cols'] = colWidths;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Ribbon Action Plan");
                XLSX.writeFile(wb, "Ribbon_Action_Plan.xlsx");
            } catch (e) { console.error("Error exporting:", e); alert("Error exporting to Excel."); }
        }

        // --- Import Function (Not currently used as button is removed, but kept for completeness) ---
        /*
        function importFromCSV(event) {
             const isConfirmed = localStorage.getItem(LOCAL_STORAGE_KEY + '_confirmed') === 'true';
             if (isConfirmed) { alert("Plan is confirmed and cannot be modified by import."); csvFileInput.value = ''; return; }
             const file = event.target.files[0];
             if (!file) return;
             const reader = new FileReader();
             reader.onload = function(e) {
                 const csvText = e.target.result;
                 try {
                     const importedTasks = parseCSV(csvText);
                     if (importedTasks && importedTasks.length > 0) {
                         // Replace current tasks or append? For now, let's replace.
                         todoTableBody.innerHTML = ''; // Clear existing tasks
                         importedTasks.forEach(task => {
                             const newTaskData = {
                                 task: task["Task Description"] || "",
                                 department: task["Responsible Dept"] || departments[0],
                                 name: task["Responsible Name"] || "",
                                 email: task["Email"] || "",
                                 notes: task["Notes / Files"] || "",
                                 status: Object.keys(statusOptions).find(key => statusOptions[key] === task["Status"]) || "not-started",
                                 dueDate: task["Target Due Date"] || ""
                             };
                             createRowHtml(newTaskData);
                         });
                         alert(`${importedTasks.length} tasks imported successfully! Current plan replaced.`);
                         saveData(); // Save the new plan
                     } else { alert("Could not parse valid tasks from CSV or CSV was empty."); }
                 } catch (error) { console.error("Error processing CSV:", error); alert("Error processing CSV file."); }
                 finally { if(csvFileInput) csvFileInput.value = ''; } // Clear file input
             };
             reader.onerror = function() { alert("Error reading file."); if(csvFileInput) csvFileInput.value = ''; }
             reader.readAsText(file);
        }

         function parseCSV(csvText) {
             const lines = csvText.replace(/\r/g, "").split('\n');
             if (lines.length < 2) return [];
             const headers = lines[0].split(',').map(h => h.trim().replace(/^"(.*)"$/, '$1'));
             const tasks = [];
             for (let i = 1; i < lines.length; i++) {
                 if (lines[i].trim() === '') continue;
                 const values = [];
                 let currentVal = '';
                 let inQuotes = false;
                 for(let k=0; k < lines[i].length; k++){ // iterate with index
                     let char = lines[i][k];
                     if(char === '"' && inQuotes && k + 1 < lines[i].length && lines[i][k+1] === '"'){ // Handle "" as escaped "
                         currentVal += '"';
                         k++; // skip next quote
                     } else if (char === '"') {
                         inQuotes = !inQuotes;
                     } else if (char === ',' && !inQuotes) {
                         values.push(currentVal.trim().replace(/^"(.*)"$/, '$1'));
                         currentVal = '';
                     } else {
                         currentVal += char;
                     }
                 }
                 values.push(currentVal.trim().replace(/^"(.*)"$/, '$1'));


                 if (values.length === headers.length) {
                     const task = {};
                     for (let j = 0; j < headers.length; j++) {
                         task[headers[j]] = values[j];
                     }
                     tasks.push(task);
                 } else {
                     console.warn(`Skipping line ${i + 1}: Column count mismatch. Expected ${headers.length}, got ${values.length}. Line: ${lines[i]}`);
                 }
             }
             return tasks;
         }
        */

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', loadData);
    </script>

</body>
</html>